ROOT_DIR:=$(shell dirname $(realpath $(firstword $(MAKEFILE_LIST))))
CC = afl-gcc-fast
CXX= afl-g++-fast
INCLUDE = -Iopenssl/include -Iopenssl/test
CFLAGS = -m32 -fno-stack-protector -ggdb -Wl,-z,relro
LDFLAGS = -L$(ROOT_DIR)/openssl -l:libcrypto.so.3 -l:libcrypto.a

.DEFAULT_GOAL := harness

# What we'll actually use for fuzzing.
harness: harness.c
	AFL_USE_ASAN=1 $(CC) -o $@ $< $(CFLAGS) $(INCLUDE) $(LDFLAGS)

# Confirm that the vulnerability is present.
confirm-vulnerability: confirm-vulnerability.c
	AFL_USE_ASAN=1 $(CC) -o $@ $< $(CFLAGS) $(INCLUDE) $(LDFLAGS)

clean:
	rm -f harness
	rm -f confirm-vulnerability
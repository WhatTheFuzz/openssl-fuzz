FROM aflplusplus/aflplusplus as COMPILE

RUN dpkg --add-architecture i386 && \
    apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get -qq install git gcc-multilib libc6:i386 libstdc++6:i386

RUN git clone git://git.openssl.org/openssl.git /harness/openssl
WORKDIR /harness/openssl
# Checkout the vulnerable commit, configure, and make it.
RUN git checkout 3b421ebc64c7b52f1b9feb3812bdc7781c784332 && \
    AFL_USE_ASAN=1 CC=afl-gcc-fast CXX=afl-g++-fast ./Configure -m32 linux-generic32 && \
    AFL_USE_ASAN=1 CC=afl-gcc-fast CXX=afl-g++-fast CFLAGS="-m32" CXXFLAGS="-m32" make

# Copy over the harness and Makefile to build it.
COPY ./harness.c /harness/harness.c
COPY ./Makefile /harness/Makefile
COPY ./run.sh /harness/run.sh
COPY ./input /input

# Run the makefile to compile the harness.
WORKDIR /harness
RUN make

# Run the fuzzer.
CMD ["/harness/run.sh"]